<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Journey Path â€” SPM + EA</title>
<style>
:root{
  --brand:#06b6d4; /* change theme here */
  --bg:#0b111f;
  --panel:#121a2c;
  --muted:#a8b8e6;
  --white:#eaf0ff;
  --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 600px at 70% -10%, #1b2652 0%, var(--bg) 60%), var(--bg);color:var(--white)}
.wrap{max-width:1200px;margin:0 auto;padding:24px}
header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--brand),#9af2ff);box-shadow:0 8px 24px rgba(6,182,212,.35)}
h1{margin:0;font-size:24px}
.tag{color:var(--muted);font-size:14px}

.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.kicker{font-size:12px;letter-spacing:.12em;color:#c5f8ff;text-transform:uppercase}
.subtitle{color:#cfe8ff}
.small{font-size:12px;color:var(--muted)}
.actions{display:flex;gap:10px;flex-wrap:wrap}
button{background:var(--brand);color:#002228;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:0 8px 18px rgba(6,182,212,.3);transition:.2s}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,.2);color:#e9fbff;box-shadow:none}
button:hover{transform:translateY(-1px)}
button[disabled]{opacity:.45;cursor:not-allowed;transform:none}
.grid{display:grid;gap:12px}
.grid.personas{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.persona{cursor:pointer}
.persona.selected{outline:2px solid var(--brand);box-shadow:0 0 0 6px rgba(6,182,212,.15)}
.hidden{display:none}

/* Map */
.map{position:relative;height:440px;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.08);overflow:hidden}
#svgmap{position:absolute;inset:0}
.branch{stroke:#4b5b91;stroke-width:8;stroke-linecap:round;opacity:.35;filter: drop-shadow(0 2px 2px rgba(0,0,0,.3));}
.branch.active{stroke:var(--brand);opacity:.95}
.sign{position:absolute;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);backdrop-filter: blur(2px);cursor:pointer;transition:.2s;}
.sign:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(6,182,212,.25)}
.sign .h{font-weight:800}

.avatar{position:absolute;left:70px;top:360px;transform:translate(-20px,-20px);width:40px;height:40px;border-radius:999px;background:linear-gradient(135deg,#ffffff,#bfefff);color:#00222a;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900; box-shadow:0 8px 20px rgba(0,0,0,.35); transition: transform 900ms cubic-bezier(.2,.8,.2,1)}
.avatar::after{content:"";position:absolute;inset:-8px;border-radius:999px;box-shadow:0 0 0 0 rgba(6,182,212,.35);animation:pulse 1.8s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(6,182,212,.35)}70%{box-shadow:0 0 0 18px rgba(6,182,212,0)}100%{box-shadow:0 0 0 0 rgba(6,182,212,0)}}
.float{position:absolute;pointer-events:none;color:#fff;font-weight:800;text-shadow:0 2px 8px rgba(0,0,0,.4); animation:floatup 900ms ease-out forwards}
@keyframes floatup{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(-28px)}}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(5,8,16,.5);display:flex;align-items:center;justify-content:center;z-index:40;backdrop-filter: blur(2px)}
.sheet{width:min(720px,92vw);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.5)}

/* Gauges */
.gaugegrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:860px){.gaugegrid{grid-template-columns:1fr}}
.gauge{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
.progress{height:14px;background:#1f2a5a;border-radius:999px;overflow:hidden}
.progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--ok),var(--brand));width:0%}

/* Confetti */
canvas#fx{position:fixed;inset:0;pointer-events:none;z-index:50}

</style>
</head>
<body>
<canvas id="fx"></canvas>
<div class="wrap">
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>Journey Path â€” <span style="color:#c7f9ff">SPM + EA</span></h1>
      <div class="tag">Pick persona â†’ choose 3 forks â†’ survive 2 surprises â†’ see personaâ€‘weighted score (2â€“3 minutes).</div>
    </div>
  </header>

  <!-- Persona -->
  <section id="screen-persona" class="card">
    <div class="kicker">Step 1</div>
    <h2 style="margin:6px 0">Choose your persona</h2>
    <div class="subtitle">Each role weights Value, Risk, Cost, Architecture Fit and Timeâ€‘toâ€‘Value differently.</div>
    <div class="grid personas" id="persona-grid" style="margin-top:12px"></div>
    <div class="actions" style="justify-content:flex-end;margin-top:10px"><button id="btn-persona-next" disabled>Start the Journey</button></div>
  </section>

  <!-- Constraint -->
  <section id="screen-constraint" class="card hidden">
    <div class="kicker">Step 2</div>
    <h2 style="margin:6px 0">Constraint in play</h2>
    <div class="card" style="border-left:4px solid var(--brand)">
      <h3 id="c-title" style="margin:0 0 4px"></h3>
      <div id="c-desc" class="subtitle"></div>
    </div>
    <div class="actions" style="justify-content:flex-end;margin-top:10px"><button id="btn-constraint-next">Continue</button></div>
  </section>

  <!-- Journey -->
  <section id="screen-journey" class="card hidden">
    <div class="kicker">Step 3</div>
    <h2 style="margin:6px 0">Pick your 3 forks</h2>
    <div class="small">Signs = initiative choice. The path you take glows. Your avatar moves with you.</div>
    <div id="map" class="map" style="margin-top:10px">
      <!-- SVG map -->
      <svg id="svgmap" viewBox="0 0 1000 440" preserveAspectRatio="xMidYMid slice">
        <!-- base terrain haze -->
        <defs>
          <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#10234a" stop-opacity="0.18"/>
            <stop offset="100%" stop-color="#08132b" stop-opacity="0"/>
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="1000" height="440" fill="url(#g1)"/>
        <!-- branches -->
        <!-- Start to Fork1 -->
        <path id="b0" class="branch active" d="M80 360 C 150 340, 180 320, 220 300"/>
        <!-- Fork1 Left (AI) -->
        <path id="b1L" class="branch" d="M220 300 C 290 260, 340 240, 340 220"/>
        <!-- Fork1 Right (Cyber) -->
        <path id="b1R" class="branch" d="M220 300 C 300 320, 330 340, 340 360"/>
        <!-- Connect to Fork2 upper node -->
        <path id="b2Ubase" class="branch" d="M340 220 C 420 210, 480 220, 520 220"/>
        <!-- Connect to Fork2 lower node -->
        <path id="b2Lbase" class="branch" d="M340 360 C 420 360, 480 340, 520 320"/>
        <!-- Fork2 upper to ERP (upper) -->
        <path id="b2U" class="branch" d="M520 220 C 580 200, 640 190, 700 190"/>
        <!-- Fork2 lower to Cost (lower) -->
        <path id="b2L" class="branch" d="M520 320 C 580 330, 640 330, 700 330"/>
        <!-- Fork3 from upper bus -->
        <path id="b3Ubase" class="branch" d="M700 190 C 740 200, 760 210, 780 220"/>
        <!-- Fork3 from lower bus -->
        <path id="b3Lbase" class="branch" d="M700 330 C 740 320, 760 310, 780 300"/>
        <!-- Fork3 Left (Data) -->
        <path id="b3L" class="branch" d="M780 220 C 840 210, 900 220, 940 220"/>
        <!-- Fork3 Right (Compliance) -->
        <path id="b3R" class="branch" d="M780 300 C 840 300, 900 300, 940 300"/>
        <!-- Destination connector -->
        <path id="b4" class="branch" d="M940 220 C 955 240, 955 280, 940 300"/>
      </svg>

      <!-- Avatar -->
      <div id="avatar" class="avatar" title="You">ðŸ§­</div>

      <!-- Signs (click targets) -->
      <!-- Fork 1 -->
      <div class="sign" id="s-ai" style="left:320px; top:180px" data-fork="1" data-choice="ai">
        <div class="h">AI Service Assistant</div>
        <div class="small">Value 4 â€¢ Riskâ†“2 â€¢ Fit 2 â€¢ TTV 5 â€¢ Cost 2</div>
      </div>
      <div class="sign" id="s-cyber" style="left:320px; top:370px" data-fork="1" data-choice="cyber">
        <div class="h">Cyber Hardening</div>
        <div class="small">Value 3 â€¢ Riskâ†“5 â€¢ Fit 5 â€¢ TTV 3 â€¢ Cost 3</div>
      </div>
      <!-- Fork 2 (appears after F1) -->
      <div class="sign hidden" id="s-erp" style="left:680px; top:150px" data-fork="2" data-choice="erp">
        <div class="h">ERP Consolidation</div>
        <div class="small">Value 3 â€¢ Riskâ†“3 â€¢ Fit 4 â€¢ TTV 2 â€¢ Cost 5</div>
      </div>
      <div class="sign hidden" id="s-cost" style="left:680px; top:340px" data-fork="2" data-choice="cost">
        <div class="h">Cloud Cost Optimization</div>
        <div class="small">Value 2 â€¢ Riskâ†“3 â€¢ Fit 5 â€¢ TTV 4 â€¢ Cost 1</div>
      </div>
      <!-- Fork 3 (appears after F2) -->
      <div class="sign hidden" id="s-data" style="left:930px; top:180px" data-fork="3" data-choice="data">
        <div class="h">Data Platform</div>
        <div class="small">Value 4 â€¢ Riskâ†“2 â€¢ Fit 3 â€¢ TTV 2 â€¢ Cost 4</div>
      </div>
      <div class="sign hidden" id="s-comp" style="left:930px; top:340px" data-fork="3" data-choice="comp">
        <div class="h">Compliance Automation</div>
        <div class="small">Value 3 â€¢ Riskâ†“5 â€¢ Fit 4 â€¢ TTV 3 â€¢ Cost 2</div>
      </div>
    </div>

    <div class="actions" style="justify-content:space-between;margin-top:10px">
      <div class="small"><strong>Choices:</strong> <span id="choice-count">0</span>/3 â€¢ <strong>Budget used:</strong> <span id="budget-used">0</span>/<span id="budget-cap">10</span></div>
      <div>
        <button class="ghost" id="btn-reset">Reset path</button>
        <button id="btn-lock" disabled>Lock path</button>
      </div>
    </div>
    <div id="hint" class="small" style="margin-top:6px"></div>
  </section>

  <!-- Events -->
  <section id="screen-events" class="card hidden">
    <div class="kicker">Step 4</div>
    <h2 style="margin:6px 0">Surprise events</h2>
    <div class="card" style="border-left:4px solid var(--brand)">
      <h3 id="e-title" style="margin:0 0 6px"></h3>
      <div id="e-desc" class="subtitle" style="margin-bottom:8px"></div>
      <div id="e-actions" class="actions"></div>
    </div>
    <div class="actions" style="justify-content:flex-end;margin-top:10px"><button id="btn-next-event" class="hidden">Next</button></div>
  </section>

  <!-- Score -->
  <section id="screen-score" class="card hidden">
    <div class="kicker">Final</div>
    <h2 style="margin:6px 0">Your results</h2>
    <div class="gaugegrid" style="margin-top:10px">
      <div class="gauge"><h4>Value</h4><div class="progress"><span id="g-value"></span></div></div>
      <div class="gauge"><h4>Risk (lower is better)</h4><div class="progress"><span id="g-risk"></span></div></div>
      <div class="gauge"><h4>Cost Discipline</h4><div class="progress"><span id="g-cost"></span></div></div>
      <div class="gauge"><h4>Architecture Fit</h4><div class="progress"><span id="g-fit"></span></div></div>
      <div class="gauge" style="grid-column:1 / -1"><h4>Timeâ€‘toâ€‘Value</h4><div class="progress"><span id="g-ttv"></span></div></div>
    </div>
    <div class="card" style="margin-top:14px">
      <div id="final-score" style="font-size:32px;font-weight:800"></div>
      <div id="verdict" class="subtitle" style="margin-top:6px"></div>
      <div class="small" style="margin-top:10px">SPM â†’ prioritize by strategy & budget. EA â†’ guardrails & standards. Together â†’ faster value, lower risk.</div>
    </div>
    <div class="actions" style="justify-content:space-between;margin-top:12px">
      <button class="ghost" id="btn-copy">Copy summary</button>
      <button class="ghost" id="btn-replay">Play Again</button>
    </div>
  </section>
</div>

<!-- Modal container -->
<div id="modal" class="modal hidden"><div class="sheet"><h3 id="m-title" style="margin:0 0 6px"></h3><div id="m-body" class="subtitle"></div><div class="actions" style="justify-content:flex-end;margin-top:10px"><button id="m-close" class="ghost">Okay</button></div></div></div>

<script>
// ----- Data -----
const personas=[
  {id:'pm',name:'Portfolio Manager',focus:'Value, Cost, TTV',weights:{value:30,risk:15,cost:25,fit:10,ttv:20}},
  {id:'ea',name:'Enterprise Architect',focus:'Architecture, Risk',weights:{value:15,risk:20,cost:10,fit:40,ttv:15}},
  {id:'cioo',name:'CIO Office',focus:'Balanced governance',weights:{value:25,risk:20,cost:20,fit:15,ttv:20}},
  {id:'cio',name:'CIO',focus:'Value, Risk, Cost',weights:{value:30,risk:20,cost:20,fit:15,ttv:15}},
  {id:'coo',name:'COO',focus:'Operational Risk',weights:{value:20,risk:35,cost:10,fit:20,ttv:15}},
  {id:'pgm',name:'Program Manager',focus:'Timeâ€‘toâ€‘Value',weights:{value:20,risk:15,cost:15,fit:15,ttv:35}},
  {id:'hot',name:'Head of Transformation',focus:'Adoption & TTV',weights:{value:25,risk:15,cost:10,fit:15,ttv:35}},
];

const initiatives={
  ai:   {name:'AI Service Assistant', value:4, risk:2, fit:2, ttv:5, cost:2},
  cyber:{name:'Cyber Hardening',     value:3, risk:5, fit:5, ttv:3, cost:3},
  erp:  {name:'ERP Consolidation',   value:3, risk:3, fit:4, ttv:2, cost:5},
  cost: {name:'Cloud Cost Optimization', value:2, risk:3, fit:5, ttv:4, cost:1},
  data: {name:'Data Platform',       value:4, risk:2, fit:3, ttv:2, cost:4},
  comp: {name:'Compliance Automation',value:3, risk:5, fit:4, ttv:3, cost:2},
};

const constraints=[
  {id:'cloud', title:'Cloudâ€‘First Policy', desc:'Cloudâ€‘aligned initiatives gain Architecture Fit; ERP loses a bit.', apply:(ctx)=>{ctx.flags.cloud=true;}},
  {id:'freeze', title:'Hiring Freeze', desc:'Budget tight: budget cap reduced by 1 (9).', apply:(ctx)=>{ctx.budgetCap=9;}},
  {id:'datares', title:'Data Residency Rule', desc:'If Data Platform without Compliance, risk reduction is weaker.', apply:(ctx)=>{ctx.flags.datares=true;}},
];

const events=[
  {id:'cut', title:'Budget Cut â€” 20%', desc:'Leadership trims budget. You may swap one choice for its alternative at the same fork.', run:evCut},
  {id:'outage', title:'Critical Outage', desc:'Security incident tests resilience.', run:evOutage},
  {id:'vendor', title:'Vendor Sunset', desc:'ERP vendor changes roadmap.', run:evVendor},
  {id:'audit', title:'Audit Surprise', desc:'Regulator requests evidence earlier than planned.', run:evAudit},
];

// ----- State -----
let state={ persona:null, constraint:null, flags:{cloud:false,datares:false}, budgetCap:10, picks:[], eventQueue:[], adj:{risk:0,value:0,fit:0,ttv:0,finalPenalty:0} };

// Map coordinates per fork choice (absolute px relative to .map)
const coords={ start:[80,360], ai:[340,220], cyber:[340,360], erp:[700,190], cost:[700,330], data:[940,220], comp:[940,300] };

// ----- Utils -----
function $(id){return document.getElementById(id)}
function show(id,on){ $(id).classList.toggle('hidden',!on); }
const shuffle=arr=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
function clamp5(x){return Math.max(1,Math.min(5,x))}
function pct(x){return Math.max(0,Math.min(100,x))}
function avg(arr,key){return arr.length?arr.reduce((s,x)=>s+x[key],0)/arr.length:0}

// ----- Persona Screen -----
const personaGrid=$('persona-grid');
personas.forEach(p=>{
  const el=document.createElement('div'); el.className='card persona';
  el.innerHTML=`<div class="kicker" style="letter-spacing:.08em">${p.focus}</div><h3 style="margin:8px 0 4px">${p.name}</h3><div class="small">Weights: V${p.weights.value}% R${p.weights.risk}% C${p.weights.cost}% F${p.weights.fit}% T${p.weights.ttv}%</div>`;
  el.onclick=()=>{ document.querySelectorAll('.persona').forEach(x=>x.classList.remove('selected')); el.classList.add('selected'); state.persona=p; $('btn-persona-next').disabled=false; };
  personaGrid.appendChild(el);
});
$('btn-persona-next').onclick=()=>{
  // roll a constraint
  resetState();
  state.constraint = constraints[Math.floor(Math.random()*constraints.length)];
  state.constraint.apply(state);
  $('c-title').textContent=state.constraint.title; $('c-desc').textContent=state.constraint.desc + (state.budgetCap!==10?` (Budget cap ${state.budgetCap})`:'' );
  show('screen-persona',false); show('screen-constraint',true);
};
$('btn-constraint-next').onclick=()=>{ initJourney(); show('screen-constraint',false); show('screen-journey',true); };

function resetState(){ state.flags={cloud:false,datares:false}; state.budgetCap=10; state.picks=[]; state.eventQueue=[]; state.adj={risk:0,value:0,fit:0,ttv:0,finalPenalty:0}; unhighlightAll(); moveAvatar('start'); showSigns({f1:true,f2:false,f3:false}); updateBudgetUI(); }

// ----- Journey -----
function initJourney(){
  // attach listeners to signs
  Array.from(document.querySelectorAll('.sign')).forEach(s=> s.onclick=()=>choose(s.dataset.fork, s.dataset.choice));
  $('btn-reset').onclick=()=>{ resetState(); highlight('b0'); };
  $('btn-lock').onclick=()=>{ lockPath(); };
  $('budget-cap').textContent=state.budgetCap;
  $('hint').textContent='Tip: Earlier choices tend to improve TTV; Fit reduces future run costs.';
  highlight('b0');
}

function choose(fork, choice){
  fork=parseInt(fork,10);
  // If already made this fork, ignore
  if(state.picks.find(p=>p.fork===fork)) return;
  state.picks.push({fork, choice});

  // Visuals: highlight branch + move avatar + floaters
  if(fork===1){ highlight(choice==='ai'? 'b1L' : 'b1R'); highlight(choice==='ai'?'b2Ubase':'b2Lbase'); moveAvatar(choice); showSigns({f1:false,f2:true,f3:false}); }
  if(fork===2){ highlight(choice==='erp'? 'b2U' : 'b2L'); highlight(choice==='erp'?'b3Ubase':'b3Lbase'); moveAvatar(choice); showSigns({f1:false,f2:false,f3:true}); }
  if(fork===3){ highlight(choice==='data'? 'b3L' : 'b3R'); highlight('b4'); moveAvatar(choice); showSigns({f1:false,f2:false,f3:false}); $('btn-lock').disabled=false; }

  // Stat pop
  const st=initiatives[choice];
  floatText(`+V${st.value}`, 0, -8);
  floatText(`+R${st.risk}`, 10, -2);
  floatText(`+F${st.fit}`, -10, -2);
  floatText(`+T${st.ttv}`, 6, -14);

  updateBudgetUI();
}

function updateBudgetUI(){
  const used=state.picks.reduce((s,p)=>s+initiatives[p.choice].cost,0);
  $('choice-count').textContent = state.picks.length;
  $('budget-used').textContent = used;
  if(used>state.budgetCap){ $('hint').textContent = `Over budget (cap ${state.budgetCap}). You might need to swap during events.`; }
}

function lockPath(){
  // Need 3 picks
  if(state.picks.length!==3){ modal('Need 3 choices', 'Pick one option at each fork.'); return; }
  state.eventQueue=shuffle(events).slice(0,2);
  show('screen-journey',false); show('screen-events',true); runNextEvent();
}

function showSigns(vis){
  $('s-ai').classList.toggle('hidden',!vis.f1);
  $('s-cyber').classList.toggle('hidden',!vis.f1);
  $('s-erp').classList.toggle('hidden',!vis.f2);
  $('s-cost').classList.toggle('hidden',!vis.f2);
  $('s-data').classList.toggle('hidden',!vis.f3);
  $('s-comp').classList.toggle('hidden',!vis.f3);
}

function highlight(id){ document.querySelectorAll('.branch').forEach(b=>{ if(b.id===id) b.classList.add('active'); }); }
function unhighlightAll(){ document.querySelectorAll('.branch').forEach(b=>b.classList.remove('active')); }

function moveAvatar(point){
  const a=$('avatar');
  const [x,y]=coords[point];
  a.style.transform = `translate(${x}px, ${y}px)`;
}

function floatText(text, dx=0, dy=0){
  const a=$('avatar');
  const f=document.createElement('div'); f.className='float'; f.textContent=text;
  const rect=a.getBoundingClientRect(); const mapRect=$('map').getBoundingClientRect();
  f.style.left = (rect.left-mapRect.left + 12 + dx) + 'px';
  f.style.top  = (rect.top -mapRect.top  - 8 + dy) + 'px';
  $('map').appendChild(f); setTimeout(()=>f.remove(),900);
}

// ----- Events -----
function runNextEvent(){
  if(state.eventQueue.length===0){ finish(); return; }
  const ev=state.eventQueue.shift();
  $('e-title').textContent = ev.title;
  $('e-desc').textContent = ev.desc;
  $('e-actions').innerHTML='';
  $('btn-next-event').classList.add('hidden');
  ev.run();
}

function evCut(){
  const used=state.picks.reduce((s,p)=>s+initiatives[p.choice].cost,0);
  const info=document.createElement('div'); info.className='subtitle'; info.textContent=`Current budget use: ${used}/${state.budgetCap}.`;
  $('e-actions').appendChild(info);
  // Allow swapping on one random fork
  const swapFork = [1,2,3][Math.floor(Math.random()*3)];
  const current = state.picks.find(p=>p.fork===swapFork).choice;
  const alt = swapFork===1? (current==='ai'?'cyber':'ai') : swapFork===2? (current==='erp'?'cost':'erp') : (current==='data'?'comp':'data');
  const btn=document.createElement('button'); btn.className='ghost'; btn.textContent=`Swap Fork ${swapFork} â†’ ${initiatives[alt].name}`;
  btn.onclick=()=>{ state.picks = state.picks.map(p=> p.fork===swapFork? {...p, choice:alt} : p ); $('e-actions').innerHTML='<div class=subtitle>Swapped to operate leaner.</div>'; $('btn-next-event').classList.remove('hidden'); };
  $('e-actions').appendChild(btn);
  $('btn-next-event').onclick=runNextEvent;
}

function evOutage(){
  const hasCyber = !!state.picks.find(p=>p.choice==='cyber');
  const note=document.createElement('div'); note.className='subtitle';
  if(hasCyber){ note.textContent='Your hardening pays off. Risk improves (+3).'; state.adj.risk+=3; }
  else { note.textContent='Without hardening, incident hurts (âˆ’8 Risk).'; state.adj.risk-=8; }
  $('e-actions').appendChild(note);
  const next=document.createElement('button'); next.textContent='Next'; next.onclick=runNextEvent; $('e-actions').appendChild(next);
}

function evVendor(){
  const hasERP = !!state.picks.find(p=>p.choice==='erp');
  const note=document.createElement('div'); note.className='subtitle';
  if(hasERP){ note.textContent='Vendor shift: ERP value +2, TTV âˆ’1.'; state.adj.value+=2; state.adj.ttv-=1; }
  else { note.textContent='ERP not in scope â€” minimal impact.'; }
  $('e-actions').appendChild(note);
  const next=document.createElement('button'); next.textContent='Next'; next.onclick=runNextEvent; $('e-actions').appendChild(next);
}

function evAudit(){
  const hasComp = !!state.picks.find(p=>p.choice==='comp');
  const note=document.createElement('div'); note.className='subtitle';
  if(hasComp){ note.textContent='Automated evidence: Risk improves (+3).'; state.adj.risk+=3; }
  else { note.textContent='No automation â€” final score penalty (âˆ’10).'; state.adj.finalPenalty -= 10; }
  $('e-actions').appendChild(note);
  const next=document.createElement('button'); next.textContent='Next'; next.onclick=runNextEvent; $('e-actions').appendChild(next);
}

// ----- Scoring -----
function finish(){
  // Effective metrics from chosen initiatives
  const base = state.picks.map(p=>({id:p.choice, ...initiatives[p.choice]}));
  // Apply constraints
  base.forEach(it=>{
    if(state.flags.cloud){ if(['ai','cost','data'].includes(it.id)) it.fit=clamp5(it.fit+1); if(it.id==='erp') it.fit=clamp5(it.fit-1); }
    if(state.flags.datares && it.id==='data' && !state.picks.find(p=>p.choice==='comp')) it.risk=clamp5(it.risk-2);
  });
  // Early choice bonus to TTV (fork 1:+2, fork 2:+1, fork 3:+0)
  state.picks.forEach(p=>{ const it=base.find(x=>x.id===p.choice); it.ttv = clamp5(it.ttv + (p.fork===1?2:(p.fork===2?1:0))); });

  // Averages â†’ 0..100
  let v=avg(base,'value')/5*100; let r=avg(base,'risk')/5*100; let f=avg(base,'fit')/5*100; let t=avg(base,'ttv')/5*100;

  // Cost discipline
  const used=state.picks.reduce((s,p)=>s+initiatives[p.choice].cost,0);
  let c = used<=state.budgetCap?100:(used<=state.budgetCap+2?50:0); if(used>=state.budgetCap-1 && used<=state.budgetCap) c=Math.min(100,c+10);

  // Apply event adjustments
  v=pct(v+state.adj.value); r=pct(r+state.adj.risk); f=pct(f+state.adj.fit); t=pct(t+state.adj.ttv);

  // Weighted final
  const w=state.persona.weights;
  let final = (v*w.value + r*w.risk + c*w.cost + f*w.fit + t*w.ttv)/100;
  final = Math.max(0, Math.min(100, Math.round(final + state.adj.finalPenalty)));

  // Render gauges with animation
  animateWidth('g-value', Math.round(v));
  animateWidth('g-risk',  Math.round(r));
  animateWidth('g-cost',  Math.round(c));
  animateWidth('g-fit',   Math.round(f));
  animateWidth('g-ttv',   Math.round(t));

  $('final-score').textContent = `Final Score: ${final}/100`;
  $('verdict').innerHTML = verdictText({v,r,c,f,t,final});

  $('btn-replay').onclick=()=>location.reload();
  $('btn-copy').onclick=()=>{ navigator.clipboard.writeText(summaryText({v,r,c,f,t,final})).then(()=>modal('Copied','Summary copied to clipboard.')); };

  confetti();
  show('screen-events',false); show('screen-score',true);
}

function verdictText(scores){
  const best=Object.entries({Value:scores.v,Risk:scores.r,Cost:scores.c,Fit:scores.f,'Timeâ€‘toâ€‘Value':scores.t}).sort((a,b)=>b[1]-a[1])[0][0];
  const worst=Object.entries({Value:scores.v,Risk:scores.r,Cost:scores.c,Fit:scores.f,'Timeâ€‘toâ€‘Value':scores.t}).sort((a,b)=>a[1]-b[1])[0][0];
  const hints={Value:'Tie portfolio to OKRs.',Risk:'Fund cyber & compliance.',Cost:'Enforce budget & capacity.',Fit:'Adopt standards & reuse.', 'Timeâ€‘toâ€‘Value':'Frontâ€‘load small slices.'};
  return `<strong>${state.persona.name} view:</strong> Strongest <span style="color:#ffdba9">${best}</span>, weakest <span style="color:#ffdba9">${worst}</span>. ${hints[worst]}`;
}
function summaryText({v,r,c,f,t,final}){
  const names = state.picks.map(p=>initiatives[p.choice].name).join(', ');
  return `Persona: ${state.persona.name}\nConstraint: ${state.constraint.title}\nPath: ${names}\nScores â†’ Value ${Math.round(v)}, Risk ${Math.round(r)}, Cost ${Math.round(c)}, Fit ${Math.round(f)}, TTV ${Math.round(t)}\nFinal: ${final}/100`;
}
function animateWidth(id,p){ const el=$(id); let cur=0; const step=()=>{ cur+=Math.max(1, Math.round((p-cur)/6)); el.style.width=cur+'%'; if(cur<p) requestAnimationFrame(step); }; step(); }

// ----- Modal -----
function modal(title, body){ $('m-title').textContent=title; $('m-body').textContent=body; show('modal',true); }
$('m-close').onclick=()=>show('modal',false);

// ----- Confetti (lightweight) -----
function confetti(){
  const canvas=$('fx'); const ctx=canvas.getContext('2d');
  const W=canvas.width=window.innerWidth, H=canvas.height=window.innerHeight; const parts=[]; const N=120;
  for(let i=0;i<N;i++){ parts.push({x:Math.random()*W, y:-20-Math.random()*H*.3, vx:(Math.random()-.5)*2, vy:2+Math.random()*3, s:2+Math.random()*4, a:1, c:`hsl(${180+Math.random()*120}deg 90% 60%)`}); }
  let t=0; const tick=()=>{ ctx.clearRect(0,0,W,H); t++; let alive=false; for(const p of parts){ p.x+=p.vx; p.y+=p.vy; p.vy*=0.99; p.a*=0.993; if(p.y<H+20 && p.a>0.02){ alive=true; ctx.globalAlpha=p.a; ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,p.s,p.s); } }
    if(alive && t<400) requestAnimationFrame(tick); else { ctx.clearRect(0,0,W,H); }
  }; tick();
}

// kickoff visuals
moveAvatar('start');
highlight('b0');

</script>
</body>
</html>
